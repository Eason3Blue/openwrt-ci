name: IPQ60XX-6.12-NOWIFI

on:
  workflow_dispatch:
  schedule:
    # Every 2 hours (UTC)
    - cron: 0 */2 * * *

env:
  REPO_URL: https://github.com/LiBwrt/openwrt-6.x.git
  REPO_BRANCH: main
  CONFIG_FILE: configs/ipq60xx-6.12-nowifi.config
  DIY_SCRIPT: libwrt.sh

  FIRMWARE_TAG: IPQ60XX-6.12-NOWIFI
  RELEASE_TAG: IPQ60XX-6.12-NOWIFI

  TZ: Asia/Shanghai
  CACHE_TOOLCHAIN: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout CI repo
      uses: actions/checkout@v4

    - name: Init build environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo bash -c 'bash <(curl -sL https://build-scripts.immortalwrt.org/init_build_environment.sh)'
        sudo timedatectl set-timezone "$TZ"

    - name: Maximize disk space
      uses: easimon/maximize-build-space@master
      with:
        swap-size-mb: 1024
        root-reserve-mb: 1024

    - name: Clone LiBwrt
      run: |
        git clone --depth 1 -b $REPO_BRANCH $REPO_URL openwrt
        echo "OPENWRT_PATH=$PWD/openwrt" >> $GITHUB_ENV
        cd openwrt
        git show -s --date=short --format="VERSION_INFO=‰ΩúËÄÖ: %an<br/>Êó∂Èó¥: %cd<br/>ÂÜÖÂÆπ: %s<br/>hash: %H" >> $GITHUB_ENV

    # =========================================================
    #  ‰ªé Release ‰∏≠ËØªÂèñ‰∏ä‰∏ÄÊ¨°ÊûÑÂª∫‰ΩøÁî®ÁöÑ commit
    # =========================================================
    - name: Get last commit from Release
      id: last_commit
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        set -e
        BODY=$(gh release view "$RELEASE_TAG" --json body -q .body 2>/dev/null || true)
        if [ -z "$BODY" ]; then
          echo "last_commit=" >> $GITHUB_OUTPUT
          exit 0
        fi
        LAST=$(echo "$BODY" | grep -oE 'Commit: `[0-9a-f]{7,40}`' | tail -n1 | sed 's/.*`//;s/`//')
        echo "Last commit from release: $LAST"
        echo "last_commit=$LAST" >> $GITHUB_OUTPUT

    # =========================================================
    #  ÂØπÊØîÂΩìÂâç libwrt commit
    # =========================================================
    - name: Check libwrt commit change
      id: check_commit
      run: |
        cd openwrt
        CUR=$(git rev-parse HEAD)
        echo "Current commit: $CUR"

        if [ -n "${{ steps.last_commit.outputs.last_commit }}" ] && \
           [ "$CUR" = "${{ steps.last_commit.outputs.last_commit }}" ]; then
          echo "changed=false" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "changed=true" >> $GITHUB_OUTPUT
        echo "CURRENT_COMMIT=$CUR" >> $GITHUB_ENV

    # =========================================================
    #  Ê≤°ÊúâÊñ∞ commitÔºåÁõ¥Êé•ÁªìÊùüÔºàÊàêÂäüÔºâ
    # =========================================================
    - name: No update, skip build
      if: steps.check_commit.outputs.changed == 'false'
      run: |
        echo "No new libwrt commit, skip build."

    # =========================================================
    #  ‰ª•‰∏ãÊ≠•È™§‰ªÖÂú®ÊúâÊñ∞ commit Êó∂ÊâßË°å
    # =========================================================

    - name: Load config
      if: steps.check_commit.outputs.changed == 'true'
      run: |
        cp $CONFIG_FILE $OPENWRT_PATH/.config
        cd $OPENWRT_PATH
        make defconfig

    - name: Cache toolchain
      if: steps.check_commit.outputs.changed == 'true' && env.CACHE_TOOLCHAIN == 'true'
      uses: HiGarfield/cachewrtbuild@main
      with:
        prefix: ${{ env.OPENWRT_PATH }}

    - name: Install feeds
      if: steps.check_commit.outputs.changed == 'true'
      run: |
        cd $OPENWRT_PATH
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Run libwrt DIY script
      if: steps.check_commit.outputs.changed == 'true'
      run: |
        chmod +x $DIY_SCRIPT
        cd $OPENWRT_PATH
        $GITHUB_WORKSPACE/$DIY_SCRIPT

    - name: Download dl
      if: steps.check_commit.outputs.changed == 'true'
      run: |
        cd $OPENWRT_PATH
        make download -j8
        find dl -size -1024c -delete

    - name: Compile firmware
      if: steps.check_commit.outputs.changed == 'true'
      id: compile
      run: |
        cd $OPENWRT_PATH
        make -j$(nproc) || make -j1 || make -j1 V=s
        echo "BUILD_TIME=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV

    - name: Organize firmware
      if: steps.check_commit.outputs.changed == 'true'
      run: |
        cd $OPENWRT_PATH/bin/targets/*/*
        mkdir -p output
        cp *.bin *.img *.manifest sha256sums output/ || true
        echo "FIRMWARE_PATH=$PWD/output" >> $GITHUB_ENV

    # =========================================================
    #  ÁîüÊàê Release ËøΩÂä†ÂÜÖÂÆπÔºàÊó∂Èó¥ + commitÔºâ
    # =========================================================
    - name: Generate release note
      if: steps.check_commit.outputs.changed == 'true'
      run: |
        cat << EOF > release_note.md

---
### üïí ${BUILD_TIME} (UTC+8)
- Commit: \`${CURRENT_COMMIT}\`
- Branch: ${REPO_BRANCH}
- Platform: ${FIRMWARE_TAG}
- Kernel: Linux 6.12 + NSS
EOF

    - name: Upload firmware to Release
      if: steps.check_commit.outputs.changed == 'true'
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ env.RELEASE_TAG }}
        name: ${{ env.RELEASE_TAG }}
        allowUpdates: true
        token: ${{ secrets.GITHUB_TOKEN }}
        artifacts: ${{ env.FIRMWARE_PATH }}/*
        bodyFile: release_note.md
