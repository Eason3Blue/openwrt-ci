name: IPQ60XX-6.12-NOWIFI

on:
  workflow_dispatch:
  schedule:
    - cron: 0 */2 * * *

env:
  REPO_URL: https://github.com/LiBwrt/openwrt-6.x.git
  REPO_BRANCH: main-nss
  CONFIG_FILE: configs/ipq60xx-6.12-nowifi.config
  DIY_SCRIPT: libwrt.sh
  CLASH_KERNEL: amd64
  CACHE_TOOLCHAIN: true
  UPLOAD_BIN_DIR: false
  FIRMWARE_RELEASE: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ================= 新增：检测 libwrt 是否有新 commit =================
      - name: Check upstream commit
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e

          echo "==> Fetch latest upstream commit"
          LATEST_COMMIT=$(git ls-remote $REPO_URL refs/heads/$REPO_BRANCH | awk '{print $1}')
          echo "LATEST_COMMIT=$LATEST_COMMIT"

          echo "==> Fetch last recorded commit from release"
          LAST_COMMIT=$(gh release view --json body -q '.body' 2>/dev/null \
            | grep -oE 'Commit: [0-9a-f]{40}' \
            | tail -n 1 \
            | awk '{print $2}' || true)

          echo "LAST_COMMIT=$LAST_COMMIT"

          if [ "$LATEST_COMMIT" = "$LAST_COMMIT" ] && [ -n "$LAST_COMMIT" ]; then
            echo "No new commit, skip build."
            echo "SKIP_BUILD=true" >> $GITHUB_ENV
          else
            echo "New commit detected, continue build."
            echo "SKIP_BUILD=false" >> $GITHUB_ENV
            echo "VERSION_INFO=Commit: $LATEST_COMMIT" >> $GITHUB_ENV
          fi
      # ================= 新增结束 =================

      # ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓
      # 你原来的步骤，一个字不改，只加 if
      # ↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓↓

      - name: Build OpenWrt
        if: env.SKIP_BUILD != 'true'
        run: |
          make world -j$(nproc)

      - name: Upload firmware to release
        if: env.SKIP_BUILD != 'true'
        uses: softprops/action-gh-release@v2
        with:
          files: ${{ env.FIRMWARE_PATH }}/*
          body: |
            **This is OpenWrt Firmware for ${{ env.FIRMWARE_TAG }}**
            ### 📒 固件信息(无WIFI)
            - 无WIFI带有线NSS的6.12内核固件
            - 💻 这是 ${{ env.FIRMWARE_TAG }} 平台使用的 OpenWrt 固件
            - ⚽ 固件源码: ${{ env.REPO_URL }}
            - 💝 源码分支: ${{ env.REPO_BRANCH }}
            - 🌐 默认地址: 192.168.1.1
            - 🔑 默认密码: password
            ### 🧊 固件版本
            - 固件内核版本：${{ env.VERSION_KERNEL }}
            - 固件编译前最后一次➦[主源码](${{ env.REPO_URL }})更新记录
            - ${{ env.VERSION_INFO }}
